function newSearch(){console.log("========\n","New Search!"),clearLocationForm(),clearDateForm(),perDiemSwiper.slideTo(0)}function resetErrors(){$(".perdiem-error").hide()}function clearLocationForm(){$("#perdiem-state").val(""),$("#perdiem-zip").val(""),$("#perdiem-city").val(""),validateLocationParams(),$("#perdiem-current-location").focus()}function clearDateForm(){$("#perdiem-start-date-group").data("DateTimePicker").clear(),$("#perdiem-end-date-group").data("DateTimePicker").clear(),validateDates()}function validateMultipleRates(){console.log("Validating Rates..."),""===$("#perdiem-fiscal-year-1").val()&&$("#perdiem-fiscal-year-2").val()?$("#perdiem-rates-selected").addClass("disabled").attr("disabled","disabled"):$("#perdiem-rates-selected").removeClass("disabled").removeAttr("disabled")}function validateDates(){function e(){$("#perdiem-multiple-rates-check").addClass("disabled").attr("disabled","disabled")}function a(){$("#perdiem-multiple-rates-check").removeClass("disabled").removeAttr("disabled"),resetErrors()}resetErrors();var r=/\d{1,2}\/\d{1,2}\/\d{2,4}/,t=$("#perdiem-start-date").val(),i=$("#perdiem-end-date").val(),o=moment(t,"MM/DD/YYYY"),s=moment(i,"MM/DD/YYYY");t.match(r)&&i.match(r)&&o.isValid()&&s.isValid()?o.isBetween(validDatesBegin,validDatesEnd)&&s.isBetween(validDatesBegin,validDatesEnd)?o.isBefore(s)||o.isSame(s)?(a(),$("#perdiem-start-date").removeClass("perdiem-invalid"),$("#perdiem-end-date").removeClass("perdiem-invalid")):($("#perdiem-end-before-start").show(),e()):e():(e(),t.match(r)&&o.isValid()||""!==t&&$("#perdiem-start-date").addClass("perdiem-invalid"),i.match(r)&&s.isValid()||""!==i&&$("#perdiem-end-date").addClass("perdiem-invalid"))}function validateLocationParams(){resetErrors();var e=/\d{5}/;console.log("Validating Location..."),""===$("#perdiem-city").val()&&""===$("#perdiem-state").val()&&$("#perdiem-zip").val().length<5?$(".perdiem-step-1 #next").addClass("disabled").attr("disabled","disabled"):$("#perdiem-zip").val().match(e)||""!==$("#perdiem-state").val()?$(".perdiem-step-1 #next").removeClass("disabled").removeAttr("disabled"):$(".perdiem-step-1 #next").addClass("disabled").attr("disabled","disabled")}function checkForMultipleRates(){function e(e){if(perDiemSearch.query.zip=$("#perdiem-zip").val(),perDiemSearch.query.state=$("#perdiem-state").val(),perDiemSearch.query.city=$("#perdiem-city").val(),console.log("User Query:","State:",perDiemSearch.query.state,"City:",perDiemSearch.query.city,"ZIP:",perDiemSearch.query.zip),e&&console.log("Ignoring City Param..."),""!==perDiemSearch.query.zip){console.log("Using ZIP...");var r=apiRoot+"/api/rs/perdiem/zip/"+perDiemSearch.query.zip,t="zip"}else if(""===perDiemSearch.query.city||e){console.log("Using State Only...");var r=apiRoot+"/api/rs/perdiem/state/"+perDiemSearch.query.state;varreqType="state"}else{console.log("Using City & State...");var r=apiRoot+"/api/rs/perdiem/city/"+perDiemSearch.query.city+"/state/"+perDiemSearch.query.state,t="city-state"}a(r,t)}function a(a,t){function o(){return console.log("FY1 AJAX Call..."),$.ajax({url:l}).done(function(a){if(a.rates&&0!==a.rates.length){r=!1;var o=a.rates[0].rate;if(o.length>1){for(i in o)" "===o[i].county&&(o[i].county="Standard Rate");perDiemSearch.rates.fy1={year:perDiemSearch.startFY,multiple:!0,rates:o},console.log("Available Rates for FY1:",perDiemSearch.startFY,":",o)}else console.log("Available Rate for FY1:",perDiemSearch.startFY,":",o[0]),perDiemSearch.rates.fy1={year:perDiemSearch.startFY,multiple:!1,rate:o[0]}}else"city-state"===t?e(!0):locationError(),r=!0}).fail(function(){console.log("FY1 AJAX Call Failed!"),$("#perdiem-multiple-rates-check").html("Next"),r=!0,$("#perdiem-api-error").show()})}function s(){if(perDiemSearch.startFY!==perDiemSearch.endFY){console.log("FY2 AJAX Call...");var o=a+"/year/"+perDiemSearch.endFY;return $.ajax({url:o}).done(function(a){if(a.rates&&0!==a.rates.length){r=!1;var o=a.rates[0].rate;if(o.length>1){for(i in o)" "===o[i].county&&(o[i].county="Standard Rate");perDiemSearch.rates.fy2={year:perDiemSearch.endFY,multiple:!0,rates:o},console.log("Available Rates for FY2:",perDiemSearch.endFY,": ",o)}else console.log("Available Rate for FY2:",perDiemSearch.endFY,":",o[0]),perDiemSearch.rates.fy2={year:perDiemSearch.endFY,multiple:!1,rate:o[0]}}else"city-state"===t?e(!0):locationError(),r=!0}).fail(function(){console.log("FY2 AJAX Call Failed!"),$("#perdiem-multiple-rates-check").html("Next"),$("#perdiem-api-error").show(),r=!0})}return!0}var l=a+"/year/"+perDiemSearch.startFY;console.log("Checking available rates..."),$.when(o(),s()).done(function(){function e(){function e(e,a){return e.county>a.county}perDiemSearch.rates.fy1.multiple&&(perDiemSearch.rates.fy1.rates=perDiemSearch.rates.fy1.rates.sort(e)),perDiemSearch.rates.fy2&&perDiemSearch.rates.fy2.multiple&&(perDiemSearch.rates.fy2.rates=perDiemSearch.rates.fy2.rates.sort(e));var a=template_multiple_rates,r=Mustache.render(a,{rates:perDiemSearch.rates});$(".perdiem-choose-rates").html(r),perDiemSwiper.slideTo(4),$("#perdiem-multiple-rates-check").html("Next")}r===!0?console.log("AJAX Call(s) Returned Zero Results!"):(console.log("AJAX Call(s) Successful!"),perDiemSearch.rates.fy2?perDiemSearch.rates.fy1.multiple||perDiemSearch.rates.fy2.multiple?e():calculateRates():perDiemSearch.rates.fy1.multiple?e():calculateRates())})}$("#perdiem-multiple-rates-check").html('Next <span class="glyphicon glyphicon-refresh spinning"></span>'),resetErrors(),perDiemSearch.startDate=moment($("#perdiem-start-date").val(),"MM/DD/YYYY"),perDiemSearch.startDate.month()>8?perDiemSearch.startFY=perDiemSearch.startDate.year()+1:perDiemSearch.startFY=perDiemSearch.startDate.year(),perDiemSearch.endDate=moment($("#perdiem-end-date").val(),"MM/DD/YYYY"),perDiemSearch.endDate.month()>8?perDiemSearch.endFY=perDiemSearch.endDate.year()+1:perDiemSearch.endFY=perDiemSearch.endDate.year(),console.log("Start Date:",perDiemSearch.startDate.format("MM-DD-YYYY"),"End Date:",perDiemSearch.endDate.format("MM-DD-YYYY")),console.log("Start FY:",perDiemSearch.startFY,"End FY:",perDiemSearch.endFY),e();var r=!1}function useMyCurrentLocation(){function e(e){console.log("Reverse Geocoding: ",e);var r=e.coords.latitude,s=e.coords.longitude,l=new google.maps.LatLng(r,s);geocoder.geocode({latLng:l},function(e,r){if(r==google.maps.GeocoderStatus.OK){var s=e[0].address_components;for(i in s)"postal_code"===s[i].types[0]&&(o.zip=s[i].long_name);for(i in s)s[i].types.indexOf("locality")>-1&&(o.city=s[i].long_name);if(""===o.city)for(i in s)s[i].types.indexOf("sublocality")>-1&&(o.city=s[i].long_name);for(i in s)s[i].types.indexOf("administrative_area_level_1")>-1&&(o.state=s[i].short_name);a(),t.button("reset")}else console.log("Geocode Error!")})}function a(){console.log("Populating Form With Reverse Geocode Results..."),$("#perdiem-zip").val(o.zip),$("#perdiem-city").val(o.city),$("#perdiem-state option").each(function(){$(this).val()===o.state&&$(this).attr("selected","selected")}),setTimeout(function(){validateLocationParams()},250),$("#perdiem-zip,#perdiem-city,#perdiem-state").addClass("animated flash"),setTimeout(function(){$("#perdiem-zip,#perdiem-city,#perdiem-state").removeClass("animated flash")},2e3)}function r(){console.log("Current Position Error!")}var t=$(this).button("loading"),o={city:"",state:"",zip:""};navigator.geolocation.getCurrentPosition(e,r),geocoder=new google.maps.Geocoder}function locationError(){console.log("No Results for Location..."),$("#perdiem-location-error").show(),$("#perdiem-multiple-rates-check").html("Next"),perDiemSwiper.slideTo(0)}function calculateRates(){$("#perdiem-multiple-rates-check").html('Next <span class="glyphicon glyphicon-refresh spinning"></span>'),$("#perdiem-multiple-rates-check,#perdiem-rates-selected").html("Next"),perDiemSearch.results={breakdown:[],rateInfo:[],total:0},console.log("Calculating...");var e=moment(perDiemSearch.startDate,"MM/DD/YYYY"),a=moment(perDiemSearch.endDate,"MM/DD/YYYY");moment(perDiemSearch.startDate,"MM/DD/YYYY"),moment(perDiemSearch.endDate,"MM/DD/YYYY");if(perDiemSearch.startDate===perDiemSearch.endDate){console.log("One Day Trip (No Overnight):","MIE:",.75*perDiemSearch.rates.fy1.rate.meals);var r=.75*perDiemCalculator.rates.fy1.rate.meals}else for(var r=0,t=moment(perDiemSearch.startDate).format("MM-DD-YYYY"),o=moment(perDiemSearch.endDate).format("MM-DD-YYYY"),s=e;!s.isAfter(a);s.add(1,"days")){var l=s.format("M")-1,n=s.format("YYYY");if(l>8)var c=parseFloat(n)+1;else var c=parseFloat(n);var d=Object.keys(perDiemSearch.rates);for(i in d)if(perDiemSearch.rates[d[i]].year===c)var p=perDiemSearch.rates[d[i]].rate;console.log("=========\n","Adding Date:",s.format("MM-DD-YYYY"),"Fiscal Year:",c);var m=p.months.month[l].value,u=s.format("MMMM"),h=perDiemSearch.results.rateInfo;for(i in h)if(h[i].date===u)var D=!0;else var D=!1;if(0===h.length)var D=!1;if(D===!1&&perDiemSearch.results.rateInfo.push({date:u,lodging:formatCurrency(m),mie:formatCurrency(p.meals)}),s.format("MM-DD-YYYY")===t&&t!==o){console.log("First Day");var f=.75*p.meals;console.log("MIE at 75%:",f),r+=f,console.log("Rate:",m),r+=m;var y=m+f;perDiemSearch.results.breakdown.push({date:"First Day",fullDate:s.format("MM/DD/YY"),lodging:formatCurrency(m),mie:formatCurrency(f),isFirstLast:!0,total:formatCurrency(y)})}else if(s.format("MM-DD-YYYY")===o){if(t===o)var v="Single Day";else var v="Last Day";console.log("Last Day");var f=.75*p.meals;console.log("MIE at 75%:",f),r+=f,perDiemSearch.results.breakdown.push({date:v,fullDate:s.format("MM/DD/YY"),mie:formatCurrency(f),lodging:0,isFirstLast:!0,total:formatCurrency(f)})}else{var f=p.meals;console.log("Month:",u),console.log("Rate:",m),console.log("MIE:",f),r+=m,r+=f;var g=perDiemSearch.results.breakdown;for(i in g)if(g[i].date===u)var D=!0;else var D=!1;if(!D){var y=m+f;perDiemSearch.results.breakdown.push({isRate:!0,date:u,lodging:formatCurrency(m),mie:formatCurrency(f),total:formatCurrency(y)})}}}if(perDiemSearch.results.total=r,console.log("=========\n","Total:",perDiemSearch.results.total),console.log("=========\n","Breakdown:"),console.table(perDiemSearch.results.breakdown),perDiemSearch.rates.fy2&&perDiemSearch.rates.fy1.rate.county===perDiemSearch.rates.fy2.rate.county)var S=!0;perDiemSearch.query.stateFormatted=USStates[perDiemSearch.query.state.toLowerCase()],perDiemSearch.results.totalFormatted=formatCurrency(perDiemSearch.results.total);var Y=template_calculator_results,b=Mustache.render(Y,{perDiemSearch:perDiemSearch,sameRate:S});$("#perdiem-results").html(b),perDiemSwiper.slideTo(5)}function formatCurrency(e){if(e%1!=0)var a=e.toFixed(2);else var a=e;return a}function ratesSelected(){if(perDiemSearch.rates.fy1.multiple){var e=$("#perdiem-fiscal-year-1 option:selected").index()-1;perDiemSearch.rates.fy1.rate=perDiemSearch.rates.fy1.rates[e],console.log("User Selected:",$("#perdiem-fiscal-year-1 option:selected").text(),"For FY",perDiemSearch.rates.fy1.year)}if(perDiemSearch.rates.fy2&&perDiemSearch.rates.fy2.multiple){var a=$("#perdiem-fiscal-year-2 option:selected").index()-1;perDiemSearch.rates.fy2.rate=perDiemSearch.rates.fy2.rates[a],console.log("User Selected:",$("#perdiem-fiscal-year-2 option:selected").text(),"For FY",perDiemSearch.rates.fy2.year)}calculateRates()}function updateProgress(e){$(".progress-bar").attr("aria-valuenow",e).css("width",e+"%")}function lookUpRatesSubmit(){var e=USStates[$("#perdiem-state").val().toLowerCase()],a="http://www.gsa.gov/portal/category/100120?perdiemSearchVO.year="+$("#perdiem-rate-lookup-fiscal-year").val()+"&perdiemSearchVO.city="+$("#perdiem-city").val()+"&perdiemSearchVO.state="+e+"&perdiemSearchVO.zip="+$("#perdiem-zip").val()+"&resultName=getPerdiemRatesBySearchVO&currentCategory.categoryId=100120&x=44&y=13";window.open(a)}var perDiemSwiper,perDiemSearch={rates:{},query:{}},apiRoot=window.location.protocol+"//"+window.location.host,validDatesBegin="10/1/2012",validDatesEnd="09/30/2016",template_multiple_rates='{{#rates}} <h4>Multiple Rates are Available. Please Choose One:</h4> <br> {{#fy1}} <label for="perdiem-fiscal-year-1">Fiscal Year {{year}}, Destination County</label> <select id="perdiem-fiscal-year-1" class="form-control swiper-no-swiping"> <option value="">Select a Destination</option> {{#rates}} <option>{{county}} including {{city}}</option> {{/rates}} </select> {{/fy1}} {{#fy2}}{{#multiple}} <br> <label for="perdiem-fiscal-year-2">Fiscal Year {{year}}, Destination County</label> <select id="perdiem-fiscal-year-2" class="form-control swiper-no-swiping"> <option value="">Select a Destination</option> {{#rates}} <option>{{county}} including {{city}}</option> {{/rates}} </select> {{/multiple}}{{/fy2}} <br> <div class="row"> <div class="col-sm-6"> <button id="perdiem-to-date-range" class="btn btn-default btn-block"> Back</button> </div> <div class="col-sm-6"> <button id="perdiem-rates-selected" class="btn btn-primary btn-block disabled" disabled>Next </button> </div> </div> {{/rates}}',template_calculator_results='{{#perDiemSearch}} {{#query}} <h4>Your Search for<span class="perdiem-unbold">{{#city}} {{city}}{{#stateFormatted}},{{/stateFormatted}}{{/city}}{{#stateFormatted}} {{stateFormatted}}{{/stateFormatted}}{{#zip}} {{zip}}{{/zip}}</span></h4> <h5>Using Rates for {{/query}}<span class="perdiem-unbold">{{rates.fy1.rate.county}} including {{rates.fy1.rate.city}}{{#rates.fy2.rate.county}}{{^sameRate}} and {{rates.fy2.rate.county}} including {{rates.fy2.rate.county}}{{/sameRate}}{{/rates.fy2.rate.county}}:</span></h5> {{#results}} <div class="well well-info-bright"> <div class="row"> <div class="col-sm-3"> <h4><strong>Daily Per Diem Rates:</strong></h4> </div> <div class="col-sm-9"> <h4></h4> {{#rateInfo}} <p>{{date}} Lodging: ${{lodging}}</p> <p>{{date}} M&amp;IE: ${{mie}}</p> {{/rateInfo}} </div> </div> </div> <div class="well well-info"> <div class="row"> <div class="col-sm-3"> <h4>Estimated Trip Total:</h4> </div> <div class="col-sm-9"> <h4>${{totalFormatted}}</h4></div> </div> </div> <div class="panel-group" id="perdiem-trip-breakdown-accordion" role="tablist" aria-multiselectable="true"> <div class="panel panel-info"> <div class="panel-heading" role="tab" id="headingOne"> <h4 class="panel-title"> <a role="button" data-toggle="collapse" data-parent="#perdiem-trip-breakdown-accordion" href="#perdiem-trip-breakdown-accordion-content" aria-expanded="false" aria-controls="collapseOne"> Trip Breakdown <span class="glyphicon glyphicon-chevron-down"></span> </a> </h4> </div> <div id="perdiem-trip-breakdown-accordion-content" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne"> <div class="panel-body"> <table class="table table-striped"> <thead> <th>Date</th> <th>Max. Lodging</th> <th>M&amp;IE</th> <th>Total</th> </thead> <tbody> {{#breakdown}} <tr> <td>{{date}}{{#isRate}} Rate{{/isRate}}{{#fullDate}} ({{fullDate}}){{/fullDate}}</td> <td>{{#lodging}}${{lodging}}{{/lodging}}{{^lodging}}-{{/lodging}}</td> <td>${{mie}}{{#isFirstLast}}*{{/isFirstLast}}</td> <td>${{total}}</td> </tr> {{/breakdown}} </tbody> </table> <div class="well well-khaki"> *The first and last calendar dates of M&amp;IE are calculated at 75% </div> </div> </div> </div> </div> {{/results}} {{/perDiemSearch}}';$(function(){$("#homepage-homepage-travel-tabs").tabCollapse(),console.log("Init Per Diem App..."),validDatesBegin=moment(validDatesBegin,"MM/DD/YYYY"),validDatesEnd=moment(validDatesEnd,"MM/DD/YYYY"),perDiemSwiper=new Swiper("#perdiem-swiper",{onlyExternal:!0,a11y:!0,widgetPositioning:{horizontal:"auto",vertical:"bottom"}}),perDiemSwiper.on("slideChangeStart",function(){$("html, body").animate({scrollTop:$("#perdiem-swiper").offset().top},0)}),$.ajaxSetup({timeout:1e4});var e=!!navigator.userAgent.match(/Trident\/7.0;(.*)rv(:*)11/);console.log("UserAgent:",navigator.userAgent),console.log("Is IE11?:",e),$("#perdiem-start-date-group").datetimepicker({format:"MM/DD/YYYY",keepInvalid:!0,useCurrent:!1,minDate:validDatesBegin,maxDate:validDatesEnd,debug:e}),$("#perdiem-end-date-group").datetimepicker({format:"MM/DD/YYYY",keepInvalid:!0,useCurrent:!1,minDate:validDatesBegin,maxDate:validDatesEnd,debug:e}),$("#perdiem-swiper").on("click","#next:not(.disabled)",function(){perDiemSwiper.slideNext()}),$("#perdiem-swiper").on("click","#prev:not(.disabled)",function(){perDiemSwiper.slidePrev()}),$("#perdiem-current-location").on("click",useMyCurrentLocation),$("#perdiem-clear-location-form").on("click",clearLocationForm),$("#perdiem-new-search").on("click",newSearch),$("#perdiem-multiple-rates-check").on("click",checkForMultipleRates),$("#perdiem-swiper").on("change","#perdiem-fiscal-year-1,#perdiem-fiscal-year-2",validateMultipleRates),$("#perdiem-swiper").on("click","#perdiem-rates-selected",ratesSelected),$("#perdiem-city,#perdiem-zip").on("keyup",validateLocationParams),$("#perdiem-state").on("change",validateLocationParams),validateLocationParams(),$("#perdiem-start-date,#perdiem-end-date").on("keyup",validateDates),$("#perdiem-slide-dates:not(input)").on("click",validateDates),$("#perdiem-start-date-group").on("dp.change",validateDates),$("#perdiem-end-date-group").on("dp.change",validateDates),validateDates(),$("#perdiem-look-up-rates").on("click",function(){perDiemSwiper.slideTo(3)}),$("#perdiem-to-step-2").on("click",function(){perDiemSwiper.slideTo(1)}),$("#perdiem-swiper").on("click","#perdiem-to-date-range",function(){perDiemSwiper.slideTo(2)}),$("#perdiem-look-up-rates-submit").on("click",lookUpRatesSubmit),setTimeout(function(){perDiemSwiper.onResize()},250)});var USStates={al:"Alabama",ak:"Alaska",az:"Arizona",ar:"Arkansas",ca:"California",co:"Colorado",ct:"Connecticut",de:"Delaware",fl:"Florida",ga:"Georgia",hi:"Hawaii",id:"Idaho",il:"Illinois","in":"Indiana",ia:"Iowa",ks:"Kansas",ky:"Kentucky",la:"Louisiana",me:"Maine",md:"Maryland",ma:"Massachusetts",mi:"Michigan",mn:"Montana",ms:"Mississippi",mo:"Missouri",ne:"Nebraska",nv:"Nevada",nh:"New Hampshire",nj:"New Jersey",nm:"New Mexico",ny:"New York",nc:"North Carolina",nd:"North Dakota",oh:"Ohio",ok:"Oklahoma",or:"Oregon",pa:"Pennsylvania",ri:"Rhode Island",sc:"South Carolina",sd:"South Dakota",tn:"Tennessee",tx:"Texas",ut:"Utah",vt:"Vermont",va:"Virginia",wa:"Washington",wv:"West Virginia",wi:"Wisconsin",wy:"Wyoming"};